---
title: "Lobby"
output: html_notebook
---

```{r, setup, include=FALSE}
library("tidyverse")
library("hgchmagic")

source("./splitting_names.R")
```

```{r, reading_lobby_data}
lobby_data <- read_csv("./combined_lobby_data.csv")
n_personas <- length(unique(lobby_data$nombreCompleto))  
```

```{r, reading_words_data}
file <- "../lobby/keywords - etiquetas - Sheet1.csv"
words_data <- read_csv(file)
```

```{r, find_words}
tag_words <- function(word, tema_word) {
  lobby_data %>%
    mutate(
      sensitive = ifelse(
        grepl(word, topic, ignore.case = TRUE),
        TRUE,
        sensitive
      ),
      tag = ifelse(
        grepl(word, topic, ignore.case = TRUE), 
        word, 
        tag
      ),
      tema = ifelse(
        grepl(word, topic, ignore.case = TRUE), 
        tema_word, 
        tema
      )
    )
} 
lobby_data$sensitive <- FALSE
lobby_data$tag <- NA
lobby_data$tema <- NA
for (i in 1:nrow(words_data)) {
  lobby_data <- tag_words(words_data$`palabra clave`[i], words_data$tema[i])
}
lobby_data_sensitivo <- lobby_data %>%
  filter(sensitive == TRUE)
```

```{r reading_padron_data, cache=TRUE}
total_padron_df <- readRDS("total_padron.Rda") %>%
  mutate(nombreCompleto = NOMBRE) %>%
  select(-NOMBRE)
```

```{r splitting_names_padron}
names_table <- total_padron_df %>%
  split_names()

total_padron_df <- total_padron_df %>%
  merge(names_table, by = "nombreCompleto")
```


```{r merge_data}
merged_data <- merge(lobby_data, total_padron_df, 
                     by = "nombreCompleto")
```

# Informacion general

**Padron**

- Numero de personas analizado correctamente: `r nrow(total_padron_df)`
- Numero de personans con el mismo nobre: `r nrow(total_padron_df) - length(unique(total_padron_df$NOMBRE))`

**Lobby**

- Numero de personas en estas reuniones: `r n_personas`
- Numero de personas en reuniones sensitivo: `r nrow(lobby_data_sensitivo)`
- Numero de peronas enconro en el padron: `r nrow(merged_data)`

```{r counts}
hgch_bar_ver_top_Cat(lobby_data$sensitive, title = "Numero de Reuniones sensitivo")
hgch_bar_ver_top_Cat(lobby_data$tema, title = "Numero de Reuniones sensitivo por tema")
hgch_bar_ver_top_Cat(lobby_data$tag, title = "Numero de Reuniones sensitivo por palabra", topn = 10)
hgch_bar_ver_Cat(month(lobby_data_sensitivo$fecha), title = "Numero de Reuniones sensitivo por mes")
```
